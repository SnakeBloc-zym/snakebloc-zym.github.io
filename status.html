<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SnakeBloc Community - 状态监控</title>
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/lxgw-wenkai-screen-webfont@1.7.0/style.min.css">
	<script src="https://cdn.jsdmirror.com/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdmirror.com/npm/@supabase/supabase-js@2"></script>
	<style>
		@font-face {
			font-family: 'Caveat';
			src: url('https://cdn.jsdmirror.com/gh/googlefonts/caveat/fonts/ttf/Caveat-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: swap;
		}

		body {
			font-family: LXGW Wenkai Screen, sans-serif;
			margin: 0;
			padding: 0;
			background-color: #f0f8ff;
			/* 浅蓝色背景 */
			color: #333;
		}

		.container {
			max-width: 1200px;
			margin: 20px auto;
			padding: 20px;
		}

		.header {
			text-align: center;
			margin-bottom: 30px;
		}

		.logo {
			font-size: 36px;
			font-weight: bold;
			font-family: 'Caveat', cursive;
			color: #2c3e50;
		}

		.status-card {
			background-color: white;
			border-radius: 15px;
			padding: 25px;
			margin-bottom: 25px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			border: 1px solid rgba(135, 206, 250, 0.3);
		}

		.card-title {
			font-size: 24px;
			font-weight: bold;
			margin-bottom: 20px;
			color: #2c3e50;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.card-title i {
			color: #059669;
			/* SnakeBloc 主色调 */
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-item {
			background-color: #f8fafc;
			border: 1px solid #e2e8f0;
			border-radius: 10px;
			padding: 15px;
			text-align: center;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		}

		.stat-value {
			font-size: 28px;
			font-weight: bold;
			color: #059669;
		}

		.stat-label {
			font-size: 16px;
			color: #7f8c8d;
			margin-top: 5px;
		}

		.chart-container {
			height: 300px;
			margin-top: 20px;
			position: relative;
		}

		.loading {
			text-align: center;
			padding: 50px;
			font-size: 18px;
			color: #7f8c8d;
		}

		.error {
			color: #e74c3c;
			padding: 15px;
			background-color: #fdf2f2;
			border: 1px solid #f5c6cb;
			border-radius: 5px;
			margin-top: 20px;
		}

		.footer {
			text-align: center;
			margin-top: 30px;
			color: #7f8c8d;
			font-size: 14px;
		}

		.health-indicator {
			display: flex;
			align-items: center;
			font-size: 18px;
			font-weight: bold;
		}

		.health-indicator .status-dot {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			margin-right: 8px;
		}

		.health-indicator.healthy .status-dot {
			background-color: #10b981;
			/* 绿色 */
		}

		.health-indicator.unhealthy .status-dot {
			background-color: #ef4444;
			/* 红色 */
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 15px;
		}

		th,
		td {
			border: 1px solid #ddd;
			padding: 12px;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
			font-weight: bold;
		}

		tr:nth-child(even) {
			background-color: #f9f9f9;
		}

		/* Loading spinner for tables */
		.table-loading {
			text-align: center;
			padding: 20px;
		}

		.spinner {
			border: 4px solid rgba(0, 0, 0, 0.1);
			border-left-color: #059669;
			border-radius: 50%;
			width: 30px;
			height: 30px;
			animation: spin 1s linear infinite;
			margin: 0 auto;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<div class="logo">SnakeBloc Community</div>
			<h1><i class="fas fa-chart-line"></i> 数据库状态监控</h1>
			<p>实时查看社区平台数据库使用情况</p>
			<div id="healthIndicator" class="health-indicator">
				<span class="status-dot"></span>
				<span id="healthText">检查中...</span>
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-database"></i> 核心指标</div>
			<div id="statsContainer" class="loading">
				<i class="fas fa-spinner fa-spin"></i> 正在加载数据...
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-table"></i> 数据库表详细信息</div>
			<div id="tableStatsContainer">
				<div class="table-loading">
					<div class="spinner"></div>
				</div>
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-user-clock"></i> 用户活跃度</div>
			<div id="userActivityContainer">
				<div class="table-loading">
					<div class="spinner"></div>
				</div>
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-users"></i> 用户增长趋势</div>
			<div class="chart-container">
				<canvas id="userGrowthChart"></canvas>
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-comments"></i> 消息量统计</div>
			<div class="chart-container">
				<canvas id="messageVolumeChart"></canvas>
			</div>
		</div>

		<div class="status-card">
			<div class="card-title"><i class="fas fa-book"></i> 文章状态分布</div>
			<div class="chart-container">
				<canvas id="articleStatusChart"></canvas>
			</div>
		</div>

		<div id="errorMessage" class="error hidden"></div>

		<div class="footer">
			<p>SnakeBloc Community Status Dashboard | 数据更新于 <span id="lastUpdated"></span></p>
		</div>
	</div>

	<script>
		// --- Supabase 配置 ---
		const supabaseUrl = 'https://rruioupxqqovjskdxbsz.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvdXB4cXFvdmpza2R4YnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MDMxMjAsImV4cCI6MjA2OTI3OTEyMH0.is1Y3XVBu_mXyDKUjEoGhJtzzncD0wtcSrqLcnfm24c';
		const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

		// --- DOM 元素 ---
		const statsContainer = document.getElementById('statsContainer');
		const tableStatsContainer = document.getElementById('tableStatsContainer');
		const userActivityContainer = document.getElementById('userActivityContainer');
		const errorMessage = document.getElementById('errorMessage');
		const lastUpdatedElement = document.getElementById('lastUpdated');
		const healthIndicator = document.getElementById('healthIndicator');
		const healthText = document.getElementById('healthText');

		// --- 图表实例 ---
		let userGrowthChart = null;
		let messageVolumeChart = null;
		let articleStatusChart = null;

		// --- 工具函数 ---
		function showError(msg) {
			errorMessage.textContent = `错误: ${msg}`;
			errorMessage.classList.remove('hidden');
			statsContainer.innerHTML = '<p>加载失败，请检查控制台或稍后重试。</p>';
		}

		function hideError() {
			errorMessage.classList.add('hidden');
		}

		function updateLastUpdated() {
			const now = new Date();
			lastUpdatedElement.textContent = now.toLocaleString('zh-CN');
		}

		function updateHealthIndicator(isHealthy, message) {
			healthIndicator.className = 'health-indicator'; // Reset classes
			if (isHealthy) {
				healthIndicator.classList.add('healthy');
				healthText.textContent = '系统健康';
			} else {
				healthIndicator.classList.add('unhealthy');
				healthText.textContent = message || '系统异常';
			}
		}

		// --- 数据获取与渲染 ---
		async function fetchStats() {
			try {
				hideError();
				statsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在加载数据...</div>';

				// 1. 用户总数
				const { count: userCount, error: userError } = await supabaseClient
					.from('profiles')
					.select('*', { count: 'exact', head: true });
				if (userError) throw userError;

				// 2. 公共消息总数
				const { count: publicMsgCount, error: pubMsgError } = await supabaseClient
					.from('public_messages')
					.select('*', { count: 'exact', head: true });
				if (pubMsgError) throw pubMsgError;

				// 3. 群组消息总数
				const { count: groupMsgCount, error: groupMsgError } = await supabaseClient
					.from('group_messages')
					.select('*', { count: 'exact', head: true });
				if (groupMsgError) throw groupMsgError;

				// 4. 群组总数
				const { count: groupCount, error: groupError } = await supabaseClient
					.from('groups')
					.select('*', { count: 'exact', head: true });
				if (groupError) throw groupError;

				// 5. 草稿文章数
				const { count: draftCount, error: draftError } = await supabaseClient
					.from('articles')
					.select('*', { count: 'exact', head: true })
					.eq('status', 'draft');
				if (draftError) throw draftError;

				// 6. 待审核文章数
				const { count: pendingCount, error: pendingError } = await supabaseClient
					.from('articles')
					.select('*', { count: 'exact', head: true })
					.eq('status', 'pending');
				if (pendingError) throw pendingError;

				// 7. 已发布文章数
				const { count: publishedCount, error: publishedError } = await supabaseClient
					.from('articles')
					.select('*', { count: 'exact', head: true })
					.eq('status', 'published');
				if (publishedError) throw publishedError;

				// 8. 总文章数
				const { count: articleCount, error: articleError } = await supabaseClient
					.from('articles')
					.select('*', { count: 'exact', head: true });
				if (articleError) throw articleError;

				// 渲染核心指标
				statsContainer.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${userCount}</div>
                            <div class="stat-label">总用户数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${publicMsgCount + groupMsgCount}</div>
                            <div class="stat-label">总消息数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${groupCount}</div>
                            <div class="stat-label">群组数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${articleCount}</div>
                            <div class="stat-label">总文章数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${publishedCount}</div>
                            <div class="stat-label">已发布</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${pendingCount}</div>
                            <div class="stat-label">待审核</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${draftCount}</div>
                            <div class="stat-label">草稿</div>
                        </div>
                    </div>
                `;

				updateLastUpdated();

			} catch (error) {
				console.error("获取核心指标失败:", error);
				showError(`获取核心指标失败: ${error.message}`);
			}
		}

		async function fetchTableStats() {
			tableStatsContainer.innerHTML = '<div class="table-loading"><div class="spinner"></div></div>';
			try {
				const tables = ['profiles', 'public_messages', 'group_messages', 'groups', 'articles', 'group_members', 'redpackets', 'redpacket_claims'];
				let tableStatsHtml = '<table><thead><tr><th>表名</th><th>行数 (估算)</th></tr></thead><tbody>';

				for (const table of tables) {
					const { count, error } = await supabaseClient
						.from(table)
						.select('*', { count: 'exact', head: true }); // 使用 exact count 可能较慢，但更准确

					if (error) {
						console.warn(`获取表 ${table} 信息失败:`, error);
						tableStatsHtml += `<tr><td>${table}</td><td>错误</td></tr>`;
					} else {
						tableStatsHtml += `<tr><td>${table}</td><td>${count}</td></tr>`;
					}
				}

				tableStatsHtml += '</tbody></table>';
				tableStatsContainer.innerHTML = tableStatsHtml;

			} catch (error) {
				console.error("获取表统计信息失败:", error);
				tableStatsContainer.innerHTML = `<p class="error">获取表统计信息失败: ${error.message}</p>`;
			}
		}


		async function fetchUserActivity() {
			userActivityContainer.innerHTML = '<div class="table-loading"><div class="spinner"></div></div>';
			try {
				const now = new Date();
				const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
				const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

				// 1. 最近登录用户数 (假设有一个 updated_at 字段)
				const { count: recentLoginCount, error: loginError } = await supabaseClient
					.from('profiles')
					.select('*', { count: 'exact', head: true })
					.gte('updated_at', oneDayAgo.toISOString()); // 假设 updated_at 表示最近活动
				if (loginError) throw loginError;

				// 2. 今日活跃用户数 (发送过消息的用户)
				// 公共消息用户
				const { data: publicUsersToday, error: pubUserError } = await supabaseClient
					.from('public_messages')
					.select('user_id')
					.gte('created_at', new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString());
				if (pubUserError) throw pubUserError;

				// 群组消息用户
				const { data: groupUsersToday, error: groupUserError } = await supabaseClient
					.from('group_messages')
					.select('user_id')
					.gte('created_at', new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString());
				if (groupUserError) throw groupUserError;

				const todayUserIds = new Set([...publicUsersToday.map(m => m.user_id), ...groupUsersToday.map(m => m.user_id)]);
				const todayActiveCount = todayUserIds.size;

				// 3. 本周活跃用户数
				const { data: publicUsersWeek, error: pubWeekError } = await supabaseClient
					.from('public_messages')
					.select('user_id')
					.gte('created_at', oneWeekAgo.toISOString());
				if (pubWeekError) throw pubWeekError;

				const { data: groupUsersWeek, error: groupWeekError } = await supabaseClient
					.from('group_messages')
					.select('user_id')
					.gte('created_at', oneWeekAgo.toISOString());
				if (groupWeekError) throw groupWeekError;

				const weekUserIds = new Set([...publicUsersWeek.map(m => m.user_id), ...groupUsersWeek.map(m => m.user_id)]);
				const weekActiveCount = weekUserIds.size;


				userActivityContainer.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>指标</th>
                                <th>数值</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>最近 24 小时活跃用户 (估算)</td>
                                <td>${recentLoginCount}</td>
                            </tr>
                            <tr>
                                <td>今日活跃用户 (发过消息)</td>
                                <td>${todayActiveCount}</td>
                            </tr>
                            <tr>
                                <td>本周活跃用户 (发过消息)</td>
                                <td>${weekActiveCount}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

			} catch (error) {
				console.error("获取用户活跃度失败:", error);
				userActivityContainer.innerHTML = `<p class="error">获取用户活跃度失败: ${error.message}</p>`;
			}
		}


		async function fetchChartData() {
			try {
				// 1. 用户增长趋势 (按天)
				const { data: userData, error: userError } = await supabaseClient
					.from('profiles')
					.select('created_at')
					.order('created_at', { ascending: true });
				if (userError) throw userError;

				// 简单处理数据，按天聚合
				const userCountsByDay = {};
				userData.forEach(user => {
					const date = new Date(user.created_at).toISOString().split('T')[0]; // YYYY-MM-DD
					userCountsByDay[date] = (userCountsByDay[date] || 0) + 1;
				});

				// 转换为 Chart.js 需要的格式
				const sortedDates = Object.keys(userCountsByDay).sort();
				const cumulativeUserCounts = [];
				let sum = 0;
				sortedDates.forEach(date => {
					sum += userCountsByDay[date];
					cumulativeUserCounts.push(sum);
				});

				// 2. 消息量统计 (公共 vs 群组)
				// 获取最近 N 天的数据，这里简化为最近 7 天
				const cutoffDate = new Date();
				cutoffDate.setDate(cutoffDate.getDate() - 7);
				const cutoffDateString = cutoffDate.toISOString();

				const { data: publicMsgData, error: pubMsgError } = await supabaseClient
					.from('public_messages')
					.select('created_at')
					.gte('created_at', cutoffDateString)
					.order('created_at', { ascending: true });
				if (pubMsgError) throw pubMsgError;

				const { data: groupMsgData, error: groupMsgError } = await supabaseClient
					.from('group_messages')
					.select('created_at')
					.gte('created_at', cutoffDateString)
					.order('created_at', { ascending: true });
				if (groupMsgError) throw groupMsgError;

				// 按天聚合消息
				const pubMsgCountsByDay = {};
				const groupMsgCountsByDay = {};
				publicMsgData.forEach(msg => {
					const date = new Date(msg.created_at).toISOString().split('T')[0];
					pubMsgCountsByDay[date] = (pubMsgCountsByDay[date] || 0) + 1;
				});
				groupMsgData.forEach(msg => {
					const date = new Date(msg.created_at).toISOString().split('T')[0];
					groupMsgCountsByDay[date] = (groupMsgCountsByDay[date] || 0) + 1;
				});

				// 准备最近7天的日期列表
				const last7Days = [];
				for (let i = 6; i >= 0; i--) {
					const date = new Date();
					date.setDate(date.getDate() - i);
					last7Days.push(date.toISOString().split('T')[0]);
				}

				const pubMsgCountsForChart = last7Days.map(date => pubMsgCountsByDay[date] || 0);
				const groupMsgCountsForChart = last7Days.map(date => groupMsgCountsByDay[date] || 0);

				// 3. 文章状态分布
				const { data: articleStatusData, error: articleStatusError } = await supabaseClient
					.from('articles')
					.select('status');
				if (articleStatusError) throw articleStatusError;

				const statusCounts = { draft: 0, pending: 0, published: 0, rejected: 0 };
				articleStatusData.forEach(article => {
					statusCounts[article.status] = (statusCounts[article.status] || 0) + 1;
				});


				// --- 渲染图表 ---
				renderUserGrowthChart(sortedDates, cumulativeUserCounts);
				renderMessageVolumeChart(last7Days, pubMsgCountsForChart, groupMsgCountsForChart);
				renderArticleStatusChart(statusCounts);

			} catch (error) {
				console.error("获取图表数据失败:", error);
				showError(`获取图表数据失败: ${error.message}`);
			}
		}

		function renderUserGrowthChart(labels, data) {
			const ctx = document.getElementById('userGrowthChart').getContext('2d');
			if (userGrowthChart) {
				userGrowthChart.destroy();
			}
			userGrowthChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: '累计用户数',
						data,
						borderColor: '#059669',
						backgroundColor: 'rgba(5, 150, 105, 0.1)',
						tension: 0.3,
						fill: true
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { display: true },
						tooltip: { mode: 'index', intersect: false }
					},
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: '用户数' }
						},
						x: {
							title: { display: true, text: '日期' }
						}
					}
				}
			});
		}

		function renderMessageVolumeChart(labels, pubData, groupData) {
			const ctx = document.getElementById('messageVolumeChart').getContext('2d');
			if (messageVolumeChart) {
				messageVolumeChart.destroy();
			}
			messageVolumeChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [
						{
							label: '公共消息',
							data: pubData,
							backgroundColor: 'rgba(54, 162, 235, 0.6)',
							borderColor: 'rgba(54, 162, 235, 1)',
							borderWidth: 1
						},
						{
							label: '群组消息',
							groupData,
							backgroundColor: 'rgba(153, 102, 255, 0.6)',
							borderColor: 'rgba(153, 102, 255, 1)',
							borderWidth: 1
						}
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { display: true }
					},
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: '消息数' }
						},
						x: {
							title: { display: true, text: '日期' }
						}
					}
				}
			});
		}

		function renderArticleStatusChart(statusCounts) {
			const ctx = document.getElementById('articleStatusChart').getContext('2d');
			if (articleStatusChart) {
				articleStatusChart.destroy();
			}
			articleStatusChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: ['草稿', '待审核', '已发布', '审核未通过'],
					datasets: [{
						data: [
							statusCounts.draft,
							statusCounts.pending,
							statusCounts.published,
							statusCounts.rejected || 0 // Handle potential undefined
						],
						backgroundColor: [
							'#94a3b8', // 草稿 - 灰色
							'#f59e0b', // 待审核 - 黄色
							'#10b981', // 已发布 - 绿色
							'#ef4444'  // 拒绝 - 红色
						],
						borderWidth: 1
					}]
				},
				options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						position: 'top',
					},
					tooltip: {
						callbacks: {
							label: function (context) {
								const label = context.label || '';
								const value = context.raw || 0;
								const total = context.dataset.data.reduce((a, b) => a + b, 0);
								const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			}
            });
        }

		// --- 健康检查 ---
		async function performHealthCheck() {
			try {
				// 简单的健康检查：尝试获取一个表的一行数据
				const { data, error } = await supabaseClient
					.from('profiles')
					.select('id')
					.limit(1);

				if (error) {
					throw error;
				}
				updateHealthIndicator(true);
			} catch (error) {
				console.error("健康检查失败:", error);
				updateHealthIndicator(false, `健康检查失败: ${error.message}`);
			}
		}

		// --- 初始化 ---
		document.addEventListener('DOMContentLoaded', async () => {
			await performHealthCheck(); // 先进行健康检查
			await fetchStats();
			await fetchChartData();
			await fetchTableStats(); // 获取表信息
			await fetchUserActivity(); // 获取用户活跃度
		});

	</script>
</body>

</html>