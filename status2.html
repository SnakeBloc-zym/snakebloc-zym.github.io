<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Supabase 项目统计</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 20px;
			background-color: #f5f5f5;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		.header {
			text-align: center;
			margin-bottom: 30px;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			text-align: center;
		}

		.stat-number {
			font-size: 2em;
			font-weight: bold;
			color: #20c997;
		}

		.stat-label {
			color: #666;
			margin-top: 5px;
		}

		.charts-container {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.chart-card {
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.chart-title {
			text-align: center;
			margin-bottom: 15px;
			font-size: 1.2em;
			font-weight: bold;
		}

		.loading {
			text-align: center;
			padding: 50px;
			color: #666;
		}

		.error {
			background: #f8d7da;
			color: #721c24;
			padding: 15px;
			border-radius: 4px;
			margin: 20px 0;
		}

		.controls {
			text-align: center;
			margin-bottom: 20px;
		}

		button {
			background: #20c997;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
		}

		button:hover {
			background: #1baa85;
		}

		button:disabled {
			background: #ccc;
			cursor: not-allowed;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>Supabase 项目统计仪表板</h1>
		</div>

		<div class="controls">
			<button id="refreshBtn" onclick="loadStats()">刷新数据</button>
		</div>

		<div id="loading" class="loading">
			<p>正在加载数据...</p>
		</div>

		<div id="error" class="error" style="display: none;"></div>

		<div id="dashboard" style="display: none;">
			<!-- 统计卡片 -->
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-number" id="totalTables">0</div>
					<div class="stat-label">数据表数量</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="totalRows">0</div>
					<div class="stat-label">总行数</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="totalStorage">0</div>
					<div class="stat-label">存储使用 (MB)</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="totalUsers">0</div>
					<div class="stat-label">用户数量</div>
				</div>
			</div>

			<!-- 图表区域 -->
			<div class="charts-container">
				<div class="chart-card">
					<div class="chart-title">表行数分布</div>
					<canvas id="rowCountChart"></canvas>
				</div>
				<div class="chart-card">
					<div class="chart-title">表大小分布</div>
					<canvas id="tableSizeChart"></canvas>
				</div>
				<div class="chart-card">
					<div class="chart-title">存储使用趋势</div>
					<canvas id="storageTrendChart"></canvas>
				</div>
				<div class="chart-card">
					<div class="chart-title">API 请求统计</div>
					<canvas id="apiRequestChart"></canvas>
				</div>
			</div>
		</div>
	</div>

	<script>
		const supabaseUrl = 'https://rruioupxqqovjskdxbsz.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvdXB4cXFvdmpza2R4YnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MDMxMjAsImV4cCI6MjA2OTI3OTEyMH0.is1Y3XVBu_mXyDKUjEoGhJtzzncD0wtcSrqLcnfm24c';

		// 初始化 Supabase 客户端
		const { createClient } = supabase;
		const supabaseClient = createClient(supabaseUrl, supabaseKey);

		// 图表实例
		let rowCountChart, tableSizeChart, storageTrendChart, apiRequestChart;

		// 加载统计数据
		async function loadStats() {
			try {
				showLoading(true);
				hideError();

				// 获取数据库统计信息
				const dbStats = await getDatabaseStats();

				// 获取用户统计
				const userStats = await getUserStats();

				// 获取存储统计
				const storageStats = await getStorageStats();

				// 更新统计卡片
				updateStatCards(dbStats, userStats, storageStats);

				// 更新图表
				updateCharts(dbStats, storageStats);

				showDashboard(true);
			} catch (error) {
				showError('加载数据失败: ' + error.message);
				console.error('Error loading stats:', error);
			} finally {
				showLoading(false);
			}
		}

		// 获取数据库统计信息
		async function getDatabaseStats() {
			try {
				// 获取表统计信息（需要在 Supabase 中创建相应的函数）
				const { data, error } = await supabaseClient.rpc('get_table_stats');

				if (error) throw error;
				return data || [];
			} catch (error) {
				// 如果没有自定义函数，使用替代方法
				console.warn('使用替代方法获取统计信息');
				return await getTableStatsAlternative();
			}
		}

		// 替代方法获取表统计
		async function getTableStatsAlternative() {
			try {
				// 获取所有表名
				const { data: tables, error: tableError } = await supabaseClient
					.from('pg_tables')
					.select('tablename')
					.eq('schemaname', 'public')
					.limit(10);

				if (tableError) throw tableError;

				const stats = [];
				for (let table of tables) {
					// 获取每个表的行数（注意：这可能很慢）
					try {
						const { count, error: countError } = await supabaseClient
							.from(table.tablename)
							.select('*', { count: 'exact', head: true });

						if (!countError) {
							stats.push({
								table_name: table.tablename,
								row_count: count || 0,
								table_size: Math.round(Math.random() * 1000), // 模拟数据
								total_size: Math.round(Math.random() * 1500)  // 模拟数据
							});
						}
					} catch (e) {
						console.warn(`无法获取表 ${table.tablename} 的统计信息`);
					}
				}

				return stats;
			} catch (error) {
				console.error('获取表统计失败:', error);
				return [];
			}
		}

		// 获取用户统计（适配 Authentication + profiles 模式）
		async function getUserStats() {
			try {
				// 方法1: 直接查询 auth.users（需要服务角色密钥）
				try {
					const { count, error } = await supabase
						.from('auth.users')
						.select('*', { count: 'exact', head: true });

					if (!error) {
						return count || 0;
					}
				} catch (e) {
					console.log('无法直接访问 auth.users');
				}

				// 方法2: 查询 profiles 表
				try {
					const { count, error } = await supabase
						.from('profiles')
						.select('*', { count: 'exact', head: true });

					if (!error) {
						return count || 0;
					}
				} catch (e) {
					console.log('无法访问 profiles 表');
				}

				// 方法3: 如果以上都失败，返回 0
				return 0;
			} catch (error) {
				console.warn('获取用户统计失败:', error);
				return 0;
			}
		}

		// 获取存储统计
		async function getStorageStats() {
			try {
				const { data, error } = await supabaseClient.storage.listBuckets();

				if (error) throw error;

				const buckets = [];
				for (let bucket of data) {
					try {
						const { data: objects, error: objError } = await supabaseClient.storage
							.from(bucket.name)
							.list('', { limit: 1000 });

						if (!objError) {
							const totalSize = objects.reduce((sum, obj) => sum + (obj.metadata?.size || 0), 0);
							buckets.push({
								name: bucket.name,
								objectCount: objects.length,
								totalSize: totalSize
							});
						}
					} catch (e) {
						console.warn(`无法获取存储桶 ${bucket.name} 的统计信息`);
					}
				}

				return buckets;
			} catch (error) {
				console.warn('获取存储统计失败:', error);
				return [];
			}
		}

		// 更新统计卡片
		function updateStatCards(dbStats, userCount, storageStats) {
			const totalTables = dbStats.length;
			const totalRows = dbStats.reduce((sum, table) => sum + (table.row_count || 0), 0);
			const totalStorage = storageStats.reduce((sum, bucket) => sum + (bucket.totalSize || 0), 0) / (1024 * 1024); // 转换为 MB

			document.getElementById('totalTables').textContent = totalTables;
			document.getElementById('totalRows').textContent = totalRows.toLocaleString();
			document.getElementById('totalStorage').textContent = totalStorage.toFixed(2);
			document.getElementById('totalUsers').textContent = userCount.toLocaleString();
		}

		// 更新图表
		function updateCharts(dbStats, storageStats) {
			// 表行数分布图
			updateRowCountChart(dbStats);

			// 表大小分布图
			updateTableSizeChart(dbStats);

			// 存储趋势图
			updateStorageTrendChart(storageStats);

			// API 请求统计图（模拟数据）
			updateApiRequestChart();
		}

		// 更新行数分布图
		function updateRowCountChart(data) {
			const ctx = document.getElementById('rowCountChart').getContext('2d');

			if (rowCountChart) {
				rowCountChart.destroy();
			}

			const tableNames = data.map(item => item.table_name || 'Unknown');
			const rowCounts = data.map(item => item.row_count || 0);

			rowCountChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: tableNames,
					datasets: [{
						label: '行数',
						data: rowCounts,
						backgroundColor: 'rgba(32, 201, 151, 0.6)',
						borderColor: 'rgba(32, 201, 151, 1)',
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function (value) {
									return value.toLocaleString();
								}
							}
						}
					},
					plugins: {
						legend: {
							display: false
						}
					}
				}
			});
		}

		// 更新表大小分布图
		function updateTableSizeChart(data) {
			const ctx = document.getElementById('tableSizeChart').getContext('2d');

			if (tableSizeChart) {
				tableSizeChart.destroy();
			}

			const tableNames = data.map(item => item.table_name || 'Unknown');
			const tableSizes = data.map(item => item.table_size || 0);

			tableSizeChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: tableNames,
					datasets: [{
						data: tableSizes,
						backgroundColor: [
							'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
							'#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
						],
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: {
							position: 'right'
						}
					}
				}
			});
		}

		// 更新存储趋势图
		function updateStorageTrendChart(data) {
			const ctx = document.getElementById('storageTrendChart').getContext('2d');

			if (storageTrendChart) {
				storageTrendChart.destroy();
			}

			const bucketNames = data.map(item => item.name || 'Unknown');
			const storageSizes = data.map(item => (item.totalSize || 0) / (1024 * 1024)); // 转换为 MB

			storageTrendChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: bucketNames,
					datasets: [{
						label: '存储使用量 (MB)',
						data: storageSizes,
						borderColor: 'rgba(54, 162, 235, 1)',
						backgroundColor: 'rgba(54, 162, 235, 0.2)',
						fill: true,
						tension: 0.1
					}]
				},
				options: {
					responsive: true,
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function (value) {
									return value + ' MB';
								}
							}
						}
					}
				}
			});
		}

		// 更新 API 请求统计图（模拟数据）
		function updateApiRequestChart() {
			const ctx = document.getElementById('apiRequestChart').getContext('2d');

			if (apiRequestChart) {
				apiRequestChart.destroy();
			}

			const timeLabels = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'];
			const requestCounts = [120, 80, 200, 350, 280, 180, 90];

			apiRequestChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: timeLabels,
					datasets: [{
						label: 'API 请求量',
						data: requestCounts,
						borderColor: 'rgba(255, 99, 132, 1)',
						backgroundColor: 'rgba(255, 99, 132, 0.2)',
						fill: true,
						tension: 0.1
					}]
				},
				options: {
					responsive: true,
					scales: {
						y: {
							beginAtZero: true
						}
					}
				}
			});
		}

		// 显示/隐藏加载状态
		function showLoading(show) {
			document.getElementById('loading').style.display = show ? 'block' : 'none';
		}

		// 显示/隐藏仪表板
		function showDashboard(show) {
			document.getElementById('dashboard').style.display = show ? 'block' : 'none';
		}

		// 显示错误信息
		function showError(message) {
			const errorDiv = document.getElementById('error');
			errorDiv.textContent = message;
			errorDiv.style.display = 'block';
		}

		// 隐藏错误信息
		function hideError() {
			document.getElementById('error').style.display = 'none';
		}

		// 页面加载完成后自动获取数据
		document.addEventListener('DOMContentLoaded', function () {
			loadStats();
		});
	</script>
</body>

</html>